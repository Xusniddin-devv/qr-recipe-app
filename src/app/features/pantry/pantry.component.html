<div class="p-4 md:p-6">
  @if (products$ | async; as products) { @if (products.length) {
  <div class="bg-slate-800 rounded-lg shadow-lg overflow-hidden">
    <h3
      class="mt-0 py-3 px-4 bg-slate-700/50 border-b border-slate-700 text-lg font-medium text-white"
    >
      Products
    </h3>
    <ul class="list-none p-0 m-0">
      @for (product of products; track product.name) {
      <li class="border-b border-slate-700 last:border-b-0">
        <div class="p-4">
          <div class="flex justify-between items-start">
            <div class="flex flex-col">
              <div class="flex items-center">
                <span class="font-medium text-slate-100">{{
                  product.name
                }}</span>
                @if (hasDiscount(product.name)) {
                <span
                  class="ml-2 px-2 py-0.5 text-xs bg-green-500/20 text-green-300 rounded-full"
                >
                  Discount
                </span>
                }
              </div>
              <span class="text-sm text-slate-400"
                >Qty: {{ product.quantity || 1 }}</span
              >
            </div>
            <div class="flex flex-col items-end">
              @if (hasDiscount(product.name)) {
              <span class="text-sm text-slate-500 line-through">
                {{ check.getOriginalPrice(product) | currency : "UZS " }}
              </span>
              <ng-container
                *ngIf="
                  check.getDiscountedPrice(product) | async as discountedPrice
                "
              >
                <span class="text-green-400 font-medium">
                  {{ discountedPrice | currency : "UZS " }}
                </span>
              </ng-container>
              } @else {
              <span class="text-sm text-slate-500">
                {{ product.price / product.quantity | currency : "UZS " }}
              </span>
              <span class="text-blue-400 font-medium">
                {{ product.price | currency : "UZS " }}
              </span>
              }
            </div>
          </div>
        </div>

        @if (hasDiscount(product.name)) {
        <div class="bg-green-900/30 border-t border-green-500/20 px-4 py-3">
          @for (discount of getDiscountsForProduct(product.name); track
          discount.discountName) {
          <div class="flex justify-between text-sm">
            <span class="text-green-300">{{ discount.discountName }}</span>
            <span class="font-medium text-green-300">
              -{{ discount.discountValue | currency : "UZS " }}
            </span>
          </div>
          } @if (getDiscountsForProduct(product.name).length > 1) {
          <div
            class="flex justify-between text-sm mt-2 pt-2 border-t border-green-500/20"
          >
            <span class="font-medium text-green-200">Total discount</span>
            <span class="font-medium text-green-200">
              -{{ getTotalDiscountAmount(product.name) | currency : "UZS " }}
            </span>
          </div>
          }
        </div>
        }
      </li>
      }
    </ul>
  </div>
  } @else {
  <div
    class="text-center p-8 md:p-12 mt-4 bg-slate-800 rounded-lg border border-dashed border-slate-700"
  >
    <i class="pi pi-file-excel text-6xl text-slate-500 mb-4"></i>

    <h3 class="text-2xl font-bold text-white mb-2">No Products to Display</h3>

    <p class="text-slate-400 max-w-sm mx-auto mb-6">
      This receipt appears to be empty or could not be read correctly.
    </p>

    <a
      routerLink="/scan"
      class="bg-gradient-to-r from-cyan-400 to-blue-500 text-white py-3 px-6 rounded-full font-semibold flex items-center justify-center shadow-lg hover:shadow-blue-400/50 transform transition-all duration-300 ease-in-out mx-auto w-fit"
    >
      <i class="pi pi-arrow-left mr-2"></i>
      Back to Scanner
    </a>
  </div>
  } } @if (summary$ | async; as summary) { @if (summary.length) {
  <div class="mt-6 bg-slate-800 rounded-lg shadow-lg overflow-hidden">
    <h3
      class="mt-0 py-3 px-4 bg-slate-700/50 border-b border-slate-700 text-lg font-medium text-white"
    >
      Receipt Summary
    </h3>
    <ul class="list-none p-0">
      @for (item of summary; track item.name; let last = $last) {
      <li
        class="flex justify-between py-3 px-4 border-b border-slate-700 text-slate-300"
        [class.border-b-0]="last"
        [class.font-bold]="last"
        [class.text-white]="last"
      >
        <span>{{ item.name }}</span>
        <span>
          @if (item.price !== null && item.price !== undefined) { @if
          (isItemPriceNaN(item.price)) {
          {{ item.price }}
          } @else {
          {{ item.price | currency : "UZS " }}
          } }
        </span>
      </li>
      }
    </ul>
  </div>
  } } @if (discounts$ | async; as discounts) { @if (discounts.length) {
  <div class="mt-6 bg-slate-800 rounded-lg shadow-lg overflow-hidden">
    <h3
      class="mt-0 py-3 px-4 bg-slate-700/50 border-b border-slate-700 text-lg font-medium text-green-400"
    >
      Discounts Summary
    </h3>
    <div class="p-4">
      <div class="flex justify-between mb-3 text-sm font-medium text-slate-400">
        <span>Product</span>
        <span>Discount Amount</span>
      </div>
      @for (discount of discounts; track discount.productName +
      discount.discountName) {
      <div
        class="flex justify-between py-3 border-b border-slate-700 last:border-b-0"
      >
        <div>
          <div class="text-slate-200">{{ discount.productName }}</div>
          <div class="text-xs text-slate-500">{{ discount.discountName }}</div>
        </div>
        <span class="text-green-400 font-medium">{{
          discount.discountValue | currency : "UZS "
        }}</span>
      </div>
      }

      <div
        class="flex justify-between py-3 mt-3 font-bold border-t-2 border-slate-700 text-white"
      >
        <span>Total Savings</span>
        <span class="text-green-400">
          {{ calculateTotalDiscounts(discounts) | currency : "UZS " }}
        </span>
      </div>
    </div>
  </div>
  } }
</div>
