@if(streamActive){
<div
  class="fixed inset-0 w-screen h-screen bg-slate-900 overflow-hidden block z-40 md:relative md:inset-auto md:w-full md:max-w-xl lg:max-w-2xl md:aspect-[16/9] md:mx-auto md:my-4 md:rounded-lg md:z-auto"
>
  <video
    #video
    class="w-full h-full object-cover block"
    playsinline
    muted
  ></video>
  <canvas #canvas class="hidden"></canvas>

  <div class="absolute inset-0 flex items-center justify-center">
    <svg
      class="w-[70%] h-auto"
      viewBox="0 0 100 100"
      fill="none"
      xmlns="http://www.w3.org/2000/svg"
    >
      <path
        d="M15 3H3V15"
        stroke="white"
        stroke-width="6"
        stroke-linecap="round"
        stroke-linejoin="round"
      />
      <path
        d="M85 3H97V15"
        stroke="white"
        stroke-width="6"
        stroke-linecap="round"
        stroke-linejoin="round"
      />
      <path
        d="M85 97H97V85"
        stroke="white"
        stroke-width="6"
        stroke-linecap="round"
        stroke-linejoin="round"
      />
      <path
        d="M15 97H3V85"
        stroke="white"
        stroke-width="6"
        stroke-linecap="round"
        stroke-linejoin="round"
      />
    </svg>
  </div>

  @if(status){
  <div
    class="absolute bottom-32 left-1/2 -translate-x-1/2 z-50 px-6 py-3 text-white text-center font-semibold transition-all duration-300 ease-in-out border-2 rounded-full w-auto max-w-[90%] backdrop-blur-md shadow-lg"
    [ngClass]="{
      'bg-emerald-500/80 border-emerald-400/50 animate-pulse shadow-emerald-500/20':
        decodedUrl !== null && !hasError,
      'bg-red-500/80 border-red-400/50 shadow-red-500/20': hasError
    }"
  >
    {{ status }}
  </div>
  }

  <button
    class="absolute bottom-10 left-1/2 -translate-x-1/2 bg-slate-900/60 border-2 border-slate-700 py-4 px-5 rounded-3xl text-white cursor-pointer z-50 backdrop-blur-sm flex items-center justify-center"
    (click)="toggleTorch()"
  >
    <svg
      xmlns="http://www.w3.org/2000/svg"
      width="24"
      height="24"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2.5"
      stroke-linecap="round"
      stroke-linejoin="round"
      class="h-7 w-7 transition-colors duration-300"
      [class]="torchOn ? 'fill-yellow-400 stroke-yellow-500' : 'fill-none'"
    >
      <path d="M18 6 6 18" />
      <path d="m6 6 12 12" />
      <path
        d="M3 11.6 5.1 9.5c.9-.9 2.5-.9 3.4 0l5.1 5.1c.9.9.9 2.5 0 3.4L11.5 20c-.9.9-2.5.9-3.4 0L3 14.8c-.9-.9-.9-2.5 0-3.2Z"
      />
    </svg>
  </button>
</div>
} @else {
<div class="h-full flex flex-col">
  <div
    class="flex-grow flex flex-col justify-center items-center p-6 text-center"
  >
    <h2 class="text-2xl font-bold mb-2 text-white">Scan Your Receipt</h2>
    <p class="text-slate-400 max-w-sm mx-auto mb-6">
      Tap the image below to start the camera and scan the QR code on your
      receipt.
    </p>
    <button
      (click)="startScanner()"
      class="focus:outline-none focus:ring-4 focus:ring-blue-500/50 rounded-full transition-transform duration-200 active:scale-95"
    >
      <img
        src="assets/ScanImg.png"
        alt="Tap to scan receipt"
        class="w-full max-w-sm mx-auto cursor-pointer"
      />
    </button>
  </div>

  <div class="flex-shrink-0 bg-slate-800 rounded-t-2xl p-6">
    <h2 class="text-xl font-bold mb-4 text-white">Recent Scans</h2>
    @if (isLoading()) {
    <div class="flex justify-center p-4">
      <i class="pi pi-spin pi-spinner text-3xl text-slate-400"></i>
    </div>
    } @else if (recentScans().length === 0) {
    <div class="text-center text-slate-400 bg-slate-900/50 p-6 rounded-lg">
      No recent scans found
    </div>
    } @else {
    <ul class="list-none p-0 m-0">
      @for (scan of recentScans(); track scan.id) {
      <li
        class="block border-b border-slate-700 last:border-b-0 hover:bg-slate-700/70 transition-colors rounded-lg"
      >
        <a
          [routerLink]="
            scan.success && scan.receiptId ? ['/receipt', scan.receiptId] : null
          "
          [class.cursor-pointer]="scan.success && scan.receiptId"
          [class.cursor-not-allowed]="!scan.success || !scan.receiptId"
          class="flex items-center py-4 px-4 w-full"
        >
          <i class="pi pi-clock text-slate-400 mr-4"></i>
          <div class="flex-grow overflow-hidden">
            <div class="font-medium text-slate-100">
              {{ formatScanDate(scan.timestamp) }}
            </div>
            <div class="text-sm text-slate-400 truncate">
              @if (typeof scan.totalAmount === 'number') {
              <span class="font-semibold">{{
                scan.totalAmount | currency : "UZS " : "symbol" : "1.0-0"
              }}</span>
              } @else {
              {{ scan.url }}
              }
            </div>
          </div>
          @if (scan.success) {
          <span class="text-green-400 ml-3 flex-shrink-0">
            <i class="pi pi-check-circle"></i>
          </span>
          } @else {
          <span class="text-red-400 ml-3 flex-shrink-0">
            <i class="pi pi-times-circle"></i>
          </span>
          }
        </a>
      </li>
      }
    </ul>
    }
  </div>
</div>
}
